场景

### 1. 读倾斜

读倾斜指的是，查询一个集合结果，并且这个结果满足一定规则，而外部在修改这个集合过程中，重新查询这个集合结果，如果看到了部分修改，则结果集与之前的规则不一致，此时出现了读倾斜问题（”读-修改-读“问题）

### 2. 写倾斜

写倾斜指的是，查询一个集合结果，去修改另一个集合的内容，就会出现写倾斜问题（”读-修改-写“问题）

示例1：

![截屏2022-09-05 02.59.49](/Users/bytedance/Documents/bytedance_framework/algWiki/数据库/pics/截屏2022-09-05 02.59.49.png)

> 由于没有对查询的时间区域加锁串行化，因此由于MVCC特性，会导致相同的会议室room_id=123的会议室被重复预订。（如果select ... for update，在RR隔离级别上通过的Gap锁可以解决这个问题）

示例2：

![截屏2022-09-05 03.03.07](/Users/bytedance/Documents/bytedance_framework/algWiki/数据库/pics/截屏2022-09-05 03.03.07.png)

> 原理同上。

示例3：

| T1                                                       | T2                                                       |
| -------------------------------------------------------- | -------------------------------------------------------- |
| begin;                                                   | begin;                                                   |
| exist = (select * from ta where id = 10)                 | exist = (select * from tb where id = 10)                 |
| if (exist == 0) <br />{ inert into tb (id) values (10) } |                                                          |
|                                                          | if (exist == 0) <br />{ inert into ta (id) values (10) } |
| commit                                                   | Commit                                                   |

> 原目标如果在ta和tb表中不存在一个id行，就在对方表中写入这个id的数据
>
> 上面示例的结果，最终ta和tb表都存在一个相同id的行。

### 3. 分布式事务隔离级别退化问题

单个事务参与者是RR级别，基于2PC实现的分布式事务隔离级别为RUC（读未提交）

![截屏2022-09-05 01.03.53](/Users/bytedance/Documents/bytedance_framework/algWiki/数据库/pics/截屏2022-09-05 01.03.53.png)

​		在t6时刻，发起查询时（也是走2PC），会先对节点1、2发起prepare请求（执行select * from table where id = ?时获取ReadView），由于MVCC的原因，节点1和节点2可以成功返回t6时刻视图，然后执行accept阶段，此时读到的结果之和不等于A+B，而是看到了转账过程的X。

​		这个例子也就是DDIA提到的读倾斜例子：

​		![截屏2022-09-05 02.01.05](/Users/bytedance/Documents/bytedance_framework/algWiki/数据库/pics/截屏2022-09-05 02.01.05.png)

​		如果查询发起prepare请求时，使用select ... for update，此时查询事务应该被阻塞，所以返回结果应该可以保持A+B的结果。（针对这个例子来说确实是可以避免脏读问题）

所以，如果写倾斜（“读-修改-写”）是在有数据空间存在交集的情况下发生，可以通过显示加锁形式，把并发操作串行化；但是也有例外，如果“读-修改-写”动作，在读和写的数据空间没有交集，显示加锁是失效的

> 可以想象一下对一个表有cond为[0,10,20,30,40,50]（cond为非唯一索引）的数据
>
> 执行select * from empty_table where cond = 35 for update，多个session都可以运行成功，因为select ... where cond = xxx for update会对尝试加左右开区间的范围的Gap锁（<mark>左开右闭原则</mark>），这里的示例则为(30, 35](35, 40]，合并+退化后为(30,40)，而Gap锁相互间不会阻塞；
>
> 如果存在满足条件的行，还会对查询到的唯一索引加上行锁（比如：where cond=30），此时会有cond索引的Gap锁(20,40)和唯一索引行锁xx。

> ## 间隙锁加锁规则
>
> 1. 查询过程中访问到的对象才会加锁。
> 2. 加锁的基本单位是next-key lock（前开后闭）。
> 3. 等值查询上MySQL的优化：索引上的等值查询，如果是唯一索引，next-key lock会退化为行锁，如果不是唯一索引，需要访问到第一个不满足条件的值，此时next-key lock会退化为间隙锁。
> 4. 范围查询：无论是否是唯一索引，范围查询都需要访问到不满足条件的第一个值为止。
>
> ![截屏2022-09-05 10.59.17](/Users/bytedance/Documents/bytedance_framework/algWiki/数据库/pics/截屏2022-09-05 10.59.17.png)
>
> ![截屏2022-09-05 10.59.53](/Users/bytedance/Documents/bytedance_framework/algWiki/数据库/pics/截屏2022-09-05 10.59.53.png)
>
> <mark>注意插入(id=1,age=20)被阻塞，这里的Gap锁其实是非唯一索引和唯一索引组成的符合值范围（而非单纯对非唯一索引的值取范围）</mark>
>
> 取自：https://blog.csdn.net/javaanddonet/article/details/111187345

### 小结

也就是说，如果想要解决上述问题，可以对读写具有重叠的空间串行化处理，这样一来就保证了客户端视角的一致性。其中可选的方案有：

1. 使用Serializable隔离级别，全局加锁，最严格地串行、顺序执行指令；
2. select ... for update则在Serializable基本思想上，降低锁的粒度；但是”读写“的数据没有交集的情况，select for update可能无法对两个集合加锁，所以DDIA提出了一个“实体化冲突（Materializing conflicts）”的手段，以一个具体的变更，代表“读-修改-写”整个过程涉及的不同空间的变更锁，最后再基于select ... for update来串行化这些会产生结果冲突的并行操作；















1. RR + 幻读
   
   （1）RR级别下，只要在事务期间，从<mark>快照读切换到当前读</mark>，就会出现幻读的情况。
   
   （2）在”读-不存在-写“的场景，也存在幻读的情况。
   
   测试表结构：
   
   CREATE TABLE `tb` (
     `id` bigint(11) NOT NULL AUTO_INCREMENT COMMENT 'pk',
     `varchar_t` varchar(20) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
     PRIMARY KEY (`id`),
     UNIQUE KEY `uni_var` (`varchar_t`)
   ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
   
   测试时表数据：
   
   mysql> select * from tb;
   +----+-----------+
   | id | varchar_t |
   +----+-----------+
   |  1 | a         |
   |  2 | b         |
   |  3 | c         |
   |  4 | d         |
   +----+-----------+
   4 rows in set (0.00 sec)
   
   ---
   
   （1）”读-不存在-写“
   
   读一个集合，根据读出的结果，写另一个集合。（读写集合不存在交集）
   
   场景目标：如果不存在varchar_t > 'd'，则增加一条varchar_t > 'd'的记录
   
   | 事务T1                                                       | 事务T2                                                       | 状态说明                                                     |
   | ------------------------------------------------------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
   | mysql> begin;<br/>Query OK, 0 rows affected (0.00 sec)       | mysql> begin;<br/>Query OK, 0 rows affected (0.00 sec)       |                                                              |
   | mysql> select * from tb where varchar_t > 'd';<br/>Empty set (0.00 sec) |                                                              |                                                              |
   | mysql> insert into tb values (3,'c');<br/>Query OK, 1 row affected (0.00 sec) |                                                              |                                                              |
   |                                                              | mysql> select * from tb where varchar_t > 'd';<br/>Empty set (0.00 sec) |                                                              |
   |                                                              | mysql> insert into tb values (2,'b');<br/>Query OK, 1 row affected (0.00 sec) | <mark>没有阻塞<br/>主键和唯一键都没有锁住(lastkey, +♾)<br/></mark> |
   |                                                              | mysql> select * from tb;<br/>+----+-----------+<br/>\| id \| varchar_t \|<br/>+----+-----------+<br/>\|  2 \| b         \|<br/>+----+-----------+<br/>1 row in set (0.00 sec) |                                                              |
   | mysql> commit;<br/>Query OK, 0 rows affected (0.03 sec)      |                                                              |                                                              |
   |                                                              | mysql> commit;<br/>Query OK, 0 rows affected (0.03 sec)      |                                                              |
   |                                                              | mysql> select * from tb lock in share mode;<br/>+----+-----------+<br/>\| id \| varchar_t \|<br/>+----+-----------+<br/><mark>\|  1 \| a         \| 出现幻读</mark><br/>\|  2 \| b         \|<br/>+----+-----------+<br/>2 rows in set (0.00 sec) | 快照读转当前读后<br/>出现幻读                                |
   |                                                              | mysql> select * from tb;<br/>+----+-----------+<br/>\| id \| varchar_t \|<br/>+----+-----------+<br/>\|  2 \| b         \|<br/>+----+-----------+<br/>1 row in set (0.00 sec) |                                                              |
   |                                                              | mysql> commit;<br/>Query OK, 0 rows affected (0.00 sec)      |                                                              |
   |                                                              | mysql> select * from tb;<br/>+----+-----------+<br/>\| id \| varchar_t \|<br/>+----+-----------+<br/>\|  1 \| a         \|<br/>\|  2 \| b         \|<br/>+----+-----------+<br/>2 rows in set (0.01 sec) |                                                              |
   
   （2）快照读转当前读
   
   | 事务T1                                                                          | 事务T2                                                                                                                                                                                                                                                                   | 状态说明              |
   | ----------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------- |
   | mysql> begin;<br/>Query OK, 0 rows affected (0.00 sec)                        | mysql> begin;<br/>Query OK, 0 rows affected (0.00 sec)                                                                                                                                                                                                                 |                   |
   | mysql> insert into tb values (5,'e');<br/>Query OK, 1 row affected (0.00 sec) |                                                                                                                                                                                                                                                                        |                   |
   |                                                                               | mysql> select * from tb;<br/>+----+-----------+<br/>\| id \| varchar_t \|<br/>+----+-----------+<br/>\|  1 \| a         \|<br/>\|  2 \| b         \|<br/>\|  3 \| c         \|<br/>\|  4 \| d         \|<br/>+----+-----------+<br/>4 rows in set (0.00 sec)           |                   |
   |                                                                               | mysql> select * From tb lock in share mode;                                                                                                                                                                                                                            | T2等待              |
   | mysql> commit;<br/>Query OK, 0 rows affected (0.01 sec)                       |                                                                                                                                                                                                                                                                        |                   |
   |                                                                               | +----+-----------+<br/>\| id \| varchar_t \|<br/>+----+-----------+<br/>\|  1 \| a         \|<br/>\|  2 \| b         \|<br/>\|  3 \| c         \|<br/>\|  4 \| d         \|<br/><mark>\|  5 \| e         \|</mark><br/>+----+-----------+<br/>5 rows in set (4.21 sec) | <mark>出现幻读</mark> |
   
2. RC + 不可重复读

3. 
