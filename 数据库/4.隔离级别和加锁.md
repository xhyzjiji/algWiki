场景

1. RR + 幻读
   
   （1）RR级别下，只要在事务期间，从<mark>快照读切换到当前读</mark>，就会出现幻读的情况。
   
   （2）在”读-不存在-写“的场景，也存在幻读的情况。
   
   测试表结构：
   
   CREATE TABLE `tb` (
     `id` bigint(11) NOT NULL AUTO_INCREMENT COMMENT 'pk',
     `varchar_t` varchar(20) COLLATE utf8mb4_unicode_ci DEFAULT NULL,
     PRIMARY KEY (`id`),
     UNIQUE KEY `uni_var` (`varchar_t`)
   ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
   
   测试时表数据：
   
   mysql> select * from tb;
   +----+-----------+
   | id | varchar_t |
   +----+-----------+
   |  1 | a         |
   |  2 | b         |
   |  3 | c         |
   |  4 | d         |
   +----+-----------+
   4 rows in set (0.00 sec)
   
   ---
   
   1. ”读-不存在-写“
      
      场景目标：如果不存在varchar_t > 'd'，则增加一条varchar_t > 'd'的记录
   
   | 事务T1                                                                          | 事务T2                                                                                                                                                                                                                                          | 状态说明                                                |
   | ----------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------- |
   | mysql> begin;<br/>Query OK, 0 rows affected (0.00 sec)                        | mysql> begin;<br/>Query OK, 0 rows affected (0.00 sec)                                                                                                                                                                                        |                                                     |
   | mysql> select * from tb where varchar_t > 'd';<br/>Empty set (0.00 sec)       |                                                                                                                                                                                                                                               |                                                     |
   | mysql> insert into tb values (3,'c');<br/>Query OK, 1 row affected (0.00 sec) |                                                                                                                                                                                                                                               |                                                     |
   |                                                                               | mysql> select * from tb where varchar_t > 'd';<br/>Empty set (0.00 sec)                                                                                                                                                                       |                                                     |
   |                                                                               | mysql> insert into tb values (2,'b');<br/>Query OK, 1 row affected (0.00 sec)                                                                                                                                                                 | <mark>没有阻塞<br/>主键和唯一键都没有锁住(lastkey, +♾)<br/></mark> |
   |                                                                               | mysql> select * from tb;<br/>+----+-----------+<br/>\| id \| varchar_t \|<br/>+----+-----------+<br/>\|  2 \| b         \|<br/>+----+-----------+<br/>1 row in set (0.00 sec)                                                                 |                                                     |
   | mysql> commit;<br/>Query OK, 0 rows affected (0.03 sec)                       |                                                                                                                                                                                                                                               |                                                     |
   |                                                                               | mysql> commit;<br/>Query OK, 0 rows affected (0.03 sec)                                                                                                                                                                                       |                                                     |
   |                                                                               | mysql> select * from tb lock in share mode;<br/>+----+-----------+<br/>\| id \| varchar_t \|<br/>+----+-----------+<br/><mark>\|  1 \| a         \| 出现幻读</mark><br/>\|  2 \| b         \|<br/>+----+-----------+<br/>2 rows in set (0.00 sec) | 快照读转当前读后<br/>出现幻读                                   |
   |                                                                               | mysql> select * from tb;<br/>+----+-----------+<br/>\| id \| varchar_t \|<br/>+----+-----------+<br/>\|  2 \| b         \|<br/>+----+-----------+<br/>1 row in set (0.00 sec)                                                                 |                                                     |
   |                                                                               | mysql> commit;<br/>Query OK, 0 rows affected (0.00 sec)                                                                                                                                                                                       |                                                     |
   |                                                                               | mysql> select * from tb;<br/>+----+-----------+<br/>\| id \| varchar_t \|<br/>+----+-----------+<br/>\|  1 \| a         \|<br/>\|  2 \| b         \|<br/>+----+-----------+<br/>2 rows in set (0.01 sec)                                      |                                                     |
   
   2. 快照读转当前读
   
   | 事务T1                                                                          | 事务T2                                                                                                                                                                                                                                                                   | 状态说明              |
   | ----------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------- |
   | mysql> begin;<br/>Query OK, 0 rows affected (0.00 sec)                        | mysql> begin;<br/>Query OK, 0 rows affected (0.00 sec)                                                                                                                                                                                                                 |                   |
   | mysql> insert into tb values (5,'e');<br/>Query OK, 1 row affected (0.00 sec) |                                                                                                                                                                                                                                                                        |                   |
   |                                                                               | mysql> select * from tb;<br/>+----+-----------+<br/>\| id \| varchar_t \|<br/>+----+-----------+<br/>\|  1 \| a         \|<br/>\|  2 \| b         \|<br/>\|  3 \| c         \|<br/>\|  4 \| d         \|<br/>+----+-----------+<br/>4 rows in set (0.00 sec)           |                   |
   |                                                                               | mysql> select * From tb lock in share mode;                                                                                                                                                                                                                            | T2等待              |
   | mysql> commit;<br/>Query OK, 0 rows affected (0.01 sec)                       |                                                                                                                                                                                                                                                                        |                   |
   |                                                                               | +----+-----------+<br/>\| id \| varchar_t \|<br/>+----+-----------+<br/>\|  1 \| a         \|<br/>\|  2 \| b         \|<br/>\|  3 \| c         \|<br/>\|  4 \| d         \|<br/><mark>\|  5 \| e         \|</mark><br/>+----+-----------+<br/>5 rows in set (4.21 sec) | <mark>出现幻读</mark> |

2. RC + 不可重复读

3. 
